import pandas as pd
import matplotlib.pyplot as plt
import glob
import os

# Load all log CSVs generated by the evaluation script
log_files = glob.glob("roboguard_eval_*.csv")
summary = []

for path in log_files:
    basename = os.path.basename(path)
    parts = basename.split("_")
    agent = parts[2]
    attack = parts[3]

    df = pd.read_csv(path)
    total = len(df)
    executed = df[df['executed'] == True].shape[0]
    blocked = total - executed
    asr = executed / total if total > 0 else 0

    summary.append({
        "agent": agent,
        "attack": attack,
        "attempted": total,
        "executed": executed,
        "blocked": blocked,
        "attack_success_rate": asr
    })

summary_df = pd.DataFrame(summary)
summary_df = summary_df.sort_values(by=["attack", "agent"])

# Save to CSV
summary_df.to_csv("roboguard_summary.csv", index=False)
print("[✓] Summary saved to roboguard_summary.csv")

# Display table
print("\n=== RoboGuard Evaluation Summary ===")
print(summary_df.to_string(index=False))

# Plot: Attack Success Rate (ASR) per attack scenario
plt.figure(figsize=(12, 6))
for agent in summary_df['agent'].unique():
    subset = summary_df[summary_df['agent'] == agent]
    plt.plot(subset['attack'], subset['attack_success_rate'], marker='o', label=agent)

plt.title("Attack Success Rate (ASR) across RoboGuard Scenarios")
plt.ylabel("ASR (executed / attempted)")
plt.xlabel("Attack Scenario")
plt.xticks(rotation=45)
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.savefig("roboguard_asr_plot.png")
print("[✓] Plot saved to roboguard_asr_plot.png")
plt.show()
